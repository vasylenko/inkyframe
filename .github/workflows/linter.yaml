name: Run Linters
on:
  pull_request:

env:
  TF_DIR: "infra"


jobs:
  tfsyntax:
    name: Validate and Format
    runs-on: ubuntu-latest
    container: hashicorp/terraform:1.6
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run terraform validate
        working-directory: ${{ env.TF_DIR }}
        run: |
          terraform init -backend=false
          terraform validate -no-color

      - name: Run terraform fmt
        working-directory: ${{ env.TF_DIR }}
        run: |
          terraform fmt -check -diff -recursive -no-color  

  tflint:
    name: TFlint
    runs-on: ubuntu-latest
    container: ghcr.io/terraform-linters/tflint:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cleanup tflint plugins with different architecture
        run: rm -rf infra/.tflint.d

      - name: Init linter
        working-directory: ${{ env.TF_DIR }}
        run: tflint --init --chdir=infra

      - name: Run linter
        working-directory: ${{ env.TF_DIR }}
        run: tflint --chdir=infra
